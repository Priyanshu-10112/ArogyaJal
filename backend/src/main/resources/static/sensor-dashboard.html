<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sensor Data Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .sensor-card {
            transition: transform 0.3s;
            margin-bottom: 20px;
        }
        .sensor-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .card-header {
            font-weight: bold;
        }
        .sensor-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .sensor-unit {
            font-size: 0.9rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <h1 class="text-center mb-4">Water Quality Monitoring Dashboard</h1>
        
        <!-- Device Info -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Device Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <p class="mb-1"><strong>Device ID:</strong> <span id="deviceId">-</span></p>
                                <p class="mb-1"><strong>Last Update:</strong> <span id="lastUpdate">-</span></p>
                            </div>
                            <div class="col-md-4">
                                <p class="mb-1"><strong>Location:</strong> <span id="location">-</span></p>
                                <p class="mb-1"><strong>Battery:</strong> <span id="battery">-</span>V</p>
                            </div>
                            <div class="col-md-4">
                                <p class="mb-1"><strong>Status:</strong> <span class="badge bg-success" id="status">Disconnected</span></p>
                                <button class="btn btn-sm btn-outline-primary" id="refreshBtn">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sensor Cards -->
        <div class="row">
            <!-- pH Card -->
            <div class="col-md-4">
                <div class="card sensor-card">
                    <div class="card-header bg-info text-white">
                        <i class="bi bi-droplet"></i> pH Level
                    </div>
                    <div class="card-body text-center">
                        <div class="sensor-value" id="ph-value">-</div>
                        <div class="sensor-unit">pH scale (0-14)</div>
                        <div class="mt-2">
                            <span id="ph-status" class="badge">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Turbidity Card -->
            <div class="col-md-4">
                <div class="card sensor-card">
                    <div class="card-header bg-warning text-dark">
                        <i class="bi bi-water"></i> Turbidity
                    </div>
                    <div class="card-body text-center">
                        <div class="sensor-value" id="turbidity-value">-</div>
                        <div class="sensor-unit">NTU (Nephelometric Turbidity Units)</div>
                        <div class="mt-2">
                            <span id="turbidity-status" class="badge">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TDS Card -->
            <div class="col-md-4">
                <div class="card sensor-card">
                    <div class="card-header bg-success text-white">
                        <i class="bi bi-thermometer"></i> TDS
                    </div>
                    <div class="card-body text-center">
                        <div class="sensor-value" id="tds-value">-</div>
                        <div class="sensor-unit">ppm (parts per million)</div>
                        <div class="mt-2">
                            <span id="tds-status" class="badge">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <!-- DO Card -->
            <div class="col-md-6">
                <div class="card sensor-card">
                    <div class="card-header bg-primary text-white">
                        <i class="bi bi-brightness-high"></i> Dissolved Oxygen
                    </div>
                    <div class="card-body text-center">
                        <div class="sensor-value" id="do-value">-</div>
                        <div class="sensor-unit">mg/L (milligrams per liter)</div>
                        <div class="mt-2">
                            <span id="do-status" class="badge">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Temperature Card -->
            <div class="col-md-6">
                <div class="card sensor-card">
                    <div class="card-header bg-danger text-white">
                        <i class="bi bi-thermometer-half"></i> Temperature
                    </div>
                    <div class="card-body text-center">
                        <div class="sensor-value" id="temp-value">-</div>
                        <div class="sensor-unit">Â°C (Celsius)</div>
                        <div class="mt-2">
                            <span id="temp-status" class="badge">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Sensor Data Trends</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="sensorChart" height="100"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_URL = 'https://b3273baa6c51.ngrok-free.app';
        let chart = null;

        // DOM Elements
        const elements = {
            deviceId: document.getElementById('deviceId'),
            lastUpdate: document.getElementById('lastUpdate'),
            location: document.getElementById('location'),
            battery: document.getElementById('battery'),
            status: document.getElementById('status'),
            refreshBtn: document.getElementById('refreshBtn'),
            phValue: document.getElementById('ph-value'),
            turbidityValue: document.getElementById('turbidity-value'),
            tdsValue: document.getElementById('tds-value'),
            doValue: document.getElementById('do-value'),
            tempValue: document.getElementById('temp-value'),
            phStatus: document.getElementById('ph-status'),
            turbidityStatus: document.getElementById('turbidity-status'),
            tdsStatus: document.getElementById('tds-status'),
            doStatus: document.getElementById('do-status'),
            tempStatus: document.getElementById('temp-status')
        };

        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            fetchSensorData();
            elements.refreshBtn.addEventListener('click', fetchSensorData);
            
            // Set up auto-refresh every 30 seconds
            setInterval(fetchSensorData, 30000);
        });

        // Fetch sensor data from API
        async function fetchSensorData() {
            try {
                elements.status.textContent = 'Connecting...';
                elements.status.className = 'badge bg-warning';
                
                const response = await fetch(`${API_URL}/api/sensor-data/latest`);
                if (!response.ok) throw new Error('Failed to fetch data');
                
                const data = await response.json();
                updateUI(data);
                updateChart(data);
                
                elements.status.textContent = 'Connected';
                elements.status.className = 'badge bg-success';
            } catch (error) {
                console.error('Error fetching sensor data:', error);
                elements.status.textContent = 'Connection Error';
                elements.status.className = 'badge bg-danger';
            }
        }

        // Update UI with sensor data
        function updateUI(data) {
            // Device Info
            elements.deviceId.textContent = data.deviceId || '-';
            
            // Handle timestamp - check if it's a string or already a date
            if (data.timestamp) {
                try {
                    const date = typeof data.timestamp === 'string' 
                        ? new Date(data.timestamp) 
                        : new Date(data.timestamp.seconds * 1000); // Handle Firestore timestamp
                    elements.lastUpdate.textContent = date.toLocaleString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: true
                    });
                } catch (e) {
                    console.error('Error parsing timestamp:', e);
                    elements.lastUpdate.textContent = 'Just now';
                }
            } else {
                elements.lastUpdate.textContent = 'Just now';
            }
            
            elements.location.textContent = data.location ? 
                `${data.location.lat.toFixed(4)}, ${data.location.lon.toFixed(4)}` : '-';
            elements.battery.textContent = data.battery ? data.battery.voltage.toFixed(2) : '-';

            // Sensor Values
            if (data.sensors) {
                updateSensorUI('ph', data.sensors.pH, 6.5, 8.5);
                updateSensorUI('turbidity', data.sensors.turbidity_NTU, 0, 5);
                updateSensorUI('tds', data.sensors.TDS_ppm, 0, 500);
                updateSensorUI('do', data.sensors.DO_mgL, 6, 8);
                updateSensorUI('temp', data.sensors.temperature_C, 0, 30);
            }
        }

        // Update individual sensor UI
        function updateSensorUI(sensor, value, min, max) {
            const valueElement = elements[`${sensor}Value`];
            const statusElement = elements[`${sensor}Status`];
            
            if (value !== undefined && value !== null) {
                valueElement.textContent = value;
                
                // Set status based on value range
                if (value < min || value > max) {
                    statusElement.textContent = 'Warning';
                    statusElement.className = 'badge bg-danger';
                } else {
                    statusElement.textContent = 'Normal';
                    statusElement.className = 'badge bg-success';
                }
            } else {
                valueElement.textContent = '-';
                statusElement.textContent = 'N/A';
                statusElement.className = 'badge bg-secondary';
            }
        }

        // Initialize and update chart
        function updateChart(data) {
            const ctx = document.getElementById('sensorChart').getContext('2d');
            
            // Sample data - in a real app, you would fetch historical data
            const labels = ['12:00', '13:00', '14:00', '15:00', '16:00', 'Now'];
            const lastReading = data.sensors || {};
            
            if (chart) {
                chart.destroy();
            }
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'pH',
                            data: [7.2, 7.1, 7.0, 6.9, 6.8, lastReading.pH || 0],
                            borderColor: 'rgba(75, 192, 192, 1)',
                            tension: 0.3,
                            fill: false
                        },
                        {
                            label: 'Turbidity (NTU)',
                            data: [45, 43, 42, 41, 40, lastReading.turbidity_NTU || 0],
                            borderColor: 'rgba(255, 159, 64, 1)',
                            tension: 0.3,
                            fill: false
                        },
                        {
                            label: 'TDS (ppm)',
                            data: [600, 595, 590, 585, 580, lastReading.TDS_ppm || 0],
                            borderColor: 'rgba(54, 162, 235, 1)',
                            tension: 0.3,
                            fill: false
                        },
                        {
                            label: 'DO (mg/L)',
                            data: [6.5, 6.4, 6.3, 6.2, 6.1, lastReading.DO_mgL || 0],
                            borderColor: 'rgba(255, 99, 132, 1)',
                            tension: 0.3,
                            fill: false
                        },
                        {
                            label: 'Temp (Â°C)',
                            data: [26.5, 26.8, 27.0, 27.3, 27.5, lastReading.temperature_C || 0],
                            borderColor: 'rgba(153, 102, 255, 1)',
                            tension: 0.3,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    },
                    animation: {
                        duration: 1000
                    }
                }
            });
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</body>
</html>
